# Сервис агрегации роуминговых данных

## Описание
Сервис агрегации роуминговых данных предназначен для сбора, обработки и предоставления информации о телефонных вызовах абонентов. Система обрабатывает записи данных вызовов (CDR - Call Data Records) и формирует на их основе записи данных пользователей (UDR - User Data Records), что позволяет анализировать статистику звонков и генерировать отчеты.

## Endpoints - Краткое описание
- **POST /v1/cdr** – генерирует тестовые записи CDR за прошлый год, начиная с текущей даты (текущая дата - 1 год).
- **POST /v1/cdr/report?msisdn={}&startDate={yyyy-mm-dd}&endDate={yyyy-mm-dd}** – формирует отчет по звонкам для указанного абонента за заданный период.
- **GET /v1/udr?msisdn={msisdn}&yearAndMonth={yyyy-mm}** – возвращает данные по звонкам для конкретного абонента; если параметр yearAndMonth не указан, возвращает данные за все время.
- **GET /v1/udr/all?yearAndMonth={yyyy-mm}** – возвращает данные по звонкам для всех абонентов за указанный месяц.

## Технологический стек, использованный в этом проекте:
- Java 17.0.14
- Spring Boot 3.4.3
- H2 Database
- Maven 3.9.9
- SpringDoc OpenAPI 2.8.5

## Зависимости проекта
Проект использует следующие основные зависимости:
- **Spring Boot Data JPA** - для работы с базой данных через JPA
- **Spring Boot Web** - для создания REST API
- **H2 Database** - встроенная база данных для хранения информации
- **Spring Boot Validation** - для валидации входных данных
- **SpringDoc OpenAPI** - для автоматической генерации документации API (Swagger)

## Установка и запуск

### Клонирование репозитория
1. Склонируйте репозиторий на локальную машину:
    ```bash
    git clone https://github.com/is6769/Nexign-TestCase.git
    ```

2. Перейдите в директорию проекта:
    ```bash
    cd Nexign-TestCase
    ```
3. Запустите приложение:
    ```bash
    java -jar RoamingAggregatorService-1.0.0-Stable.jar
    ```

### Инициализация тестовых данных
При запуске приложения, база данных автоматически заполняется тестовыми абонентами из файла `data.sql`. 
Уже добавлены следующие тестовые номера:
- 79000000001 - 79000000010 (10 последовательных номеров)
- 79111111111
- 79222222222
- 79999999999

Для генерации тестовых данных о звонках (CDR) между абонентами отправьте POST-запрос на эндпоинт `/v1/cdr` 
после запуска приложения.

### Настройка базы данных
База данных H2 настраивается автоматически при запуске приложения. 
Консоль H2 доступна по адресу: http://localhost:8080/h2-console

Режим создания схемы базы данных настраивается параметром `spring.jpa.hibernate.ddl-auto`, который в текущей конфигурации установлен в `create-drop`, что означает автоматическое создание базы данных при старте приложения и ее удаление после остановки.  

Параметры подключения:
JDBC URL: jdbc:h2:mem:roaming-aggregator-db

Имя пользователя: sa

Пароль: password

### Профили запуска
Приложение поддерживает два профиля конфигурации:

1. **dev** - профиль для разработки
   - Включено логирование SQL-запросов
   - H2 консоль доступна
   - Детальные логи приложения

2. **default** - производственный профиль по умолчанию
   - Отключено логирование SQL-запросов

Для запуска приложения с определенным профилем используйте один из следующих вариантов:
```bash
# Пример запуска с профилем разработки:
java -jar -Dspring.profiles.active=dev RoamingAggregatorService-1.0.0-Stable.jar

# Пример запуска с производственным профилем:
java -jar RoamingAggregatorService-1.0.0-Stable.jar
```
Это позволяет гибко настраивать параметры журналирования, в зависимости от среды.

## Дополнительная информация об использовании приложения
1. **API документация:**  
   После запуска приложения, Swagger UI доступен по адресу [http://localhost:8080/v1/swagger-ui](http://localhost:8080/v1/swagger-ui).  
   Документация предоставляет интерактивный интерфейс для тестирования эндпоинтов, просмотра схемы объектов запросов и ответов, а также содержит подробное описание каждого эндпоинта, включая примеры параметров и ответов.

2. **Логирование:**  
   В профиле **default** включено логирование SQL-запросов, что позволяет видеть все запросы, отправляемые приложением в H2 базу данных. Это можно использовать для отладки работы приложения и оптимизации запросов.  
   В производственном профиле логирование SQL отключено для повышения производительности и обеспечения безопасности.

3. **Отчеты:**  
   Запросом к эндпоинту **POST /v1/cdr** можно инициировать генерацию тестовых CDR записей за один год.  
   Для формирования отчета по звонкам для конкретного абонента используется эндпоинт **POST /v1/cdr/report**. Сгенерированный отчет сохраняется в директории `reports`, расположенной в корне приложения. Имя файла отчета включает MSISDN и UUID, что позволяет легко идентифицировать отчет и связывать его с конкретным запросом.

4. **Тестирование:**  
   Проект содержит большое количество юнит- и интеграционных тестов, которые охватывают ключевые сценарии работы с абонентами, генерацию CDR, формирование отчетов и получение UDR данных. Перед публикацией обновлений рекомендуется запускать тесты.
   Это позволит убедиться, что все функции работают корректно и изменения не нарушили функциональность.
